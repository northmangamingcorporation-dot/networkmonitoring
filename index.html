<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Network Monitoring Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
:root {
  --bg: #0d1117;
  --card: #161b22;
  --card2: #0f141b;
  --text: #e6edf3;
  --muted: #9da7b1;
  --accent: #58a6ff;
  --border: #30363d;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  margin: 0;
  padding: 16px;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

.wrap {
  flex: 1;
  width: 100%;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
}

h1 { 
  margin: 0 0 6px; 
  color: var(--accent); 
  font-weight: 700; 
  font-size: clamp(22px, 2vw, 32px);
}
.sub { color: var(--muted); margin-bottom: 18px; }

.grid {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 16px;
  flex: 1;
}

.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 16px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
}

.controls {
  display: flex; 
  gap: 8px; 
  align-items: center; 
  margin-bottom: 12px;
  flex-wrap: wrap;
}
select, button {
  background: var(--card2);
  color: var(--text);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 8px 10px;
  cursor: pointer;
  font-size: 14px;
}

.table-wrap {
  max-height: 420px; 
  overflow: auto; 
  border-radius: 10px;
}
table {
  width: 100%;
  height: 90%;
  border-collapse: collapse;
  font-size: 14px;
  overflow: hidden;
  border-radius: 10px;
}
th, td {
  padding: 10px;
  border-bottom: 1px solid var(--border);
  text-align: left;
  white-space: nowrap;
}
th { 
  background: #1f2630; 
  color: var(--accent); 
  position: sticky; 
  top: 0; 
}

.metrics {
  display: grid; 
  grid-template-columns: repeat(3, 1fr); 
  gap: 10px; 
  margin-top: 10px;
}
.metric {
  background: var(--card2);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 12px;
  text-align: center;
}
.metric .label { 
  color: var(--muted); 
  font-size: 12px; 
}
.metric .value { 
  font-size: 22px; 
  font-weight: 700; 
  margin-top: 4px; 
}

canvas { 
  width: 100% !important; 
  height: auto !important; 
  aspect-ratio: 16/9; /* keep chart aspect ratio */
  max-height: 400px;
}

/* ðŸ“± Responsive tweaks */
@media (max-width: 1200px) {
  .grid { grid-template-columns: 1.5fr 1fr; }
}
/* Default desktop/tablet: keep current order */
.grid > .card:nth-child(1) { order: 1; } /* Chart */
.grid > .card:nth-child(2) { order: 2; } /* Table */

/* ðŸ“± On mobile, ensure chart goes first and table goes second */
@media (max-width: 900px) {
  .grid { grid-template-columns: 1fr; }
  .grid > .card:nth-child(1) { order: 1; }
  .grid > .card:nth-child(2) { order: 2; margin-top: 12px; }
}

@media (max-width: 600px) {
  .controls { flex-direction: column; align-items: stretch; }
  select, button { width: 100%; }
  .metrics { grid-template-columns: 1fr; }
  .grid > .card:nth-child(1) { order: 1; }
  .grid > .card:nth-child(2) { order: 2; margin-top: 12px; }
}

  </style>
</head>
<body>
  <div class="wrap">
    <h1>ðŸ“¡ Northman Gaming Corporation</h1>
    <div class="sub">Network Monitoring Dashboard Â· Source: Google Sheet (Network_Speed_Log)</div>

    <div class="grid">
      <div class="card">
        <div class="controls">
          <label for="limit">Show last</label>
          <select id="limit">
            <option value="50">50 rows</option>
            <option value="200">200 rows</option>
            <option value="500" selected>500 rows</option>
            <option value="0">All</option>
          </select>
          <button id="refresh">Refresh</button>
        </div>
        <div class="metrics">
          <div class="metric">
            <div class="label">Latest Download</div>
            <div class="value" id="mDown">â€”</div>
          </div>
          <div class="metric">
            <div class="label">Latest Upload</div>
            <div class="value" id="mUp">â€”</div>
          </div>
          <div class="metric">
            <div class="label">Latest Ping</div>
            <div class="value" id="mPing">â€”</div>
          </div>
        </div>
        <div style="margin-top:12px">
          <canvas id="chartLine"></canvas>
        </div>
      </div>

      <div class="card">
        <div class="table-wrap">
          <table id="tbl">
            <thead>
              <tr>
                <th>Timestamp</th>
                <th>Download (Mbps)</th>
                <th>Upload (Mbps)</th>
                <th>Ping (ms)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tabletop.js/1.5.1/tabletop.min.js"></script>
  <script>
    let chart, jitterTimer = null;
    const base = { dl: 0, ul: 0, pg: 0 };
    const REFRESH_INTERVAL = 30000;
    const API_KEY = "AIzaSyAMLy_lt4KiSOTIyBKo4VE4N-29l_S39io"; // Replace with your API key
    const SPREADSHEET_ID = "175r-cZ9DokniT9vDQGU4uqtkV-BRK3WjI77vG7Ci1eI";
    const SHEET_NAME = "Network_Speed_Log";

    document.getElementById("refresh").addEventListener("click", loadData);

    async function loadData() {
      const limit = parseInt(document.getElementById("limit").value);

      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_NAME}?key=${API_KEY}`;
      const res = await fetch(url);
      const data = await res.json();

      render(data.values, limit);
    }


    function render(rowsRaw, limit) {
  // Skip headers (first row) and map indexes
  const rows = rowsRaw.slice(1).map(r => ({
    timestamp: r[0],
    download: parseFloat(r[1]) || 0,
    upload: parseFloat(r[2]) || 0,
    ping: parseFloat(r[3]) || 0
  }))
  .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

  const filtered = (limit > 0) ? rows.slice(0, limit) : rows;
  const tbody = document.querySelector("#tbl tbody");
  tbody.innerHTML = "";

  filtered.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.timestamp}</td>
      <td>${r.download.toFixed(2)}</td>
      <td>${r.upload.toFixed(2)}</td>
      <td>${r.ping.toFixed(0)}</td>
    `;
    tbody.appendChild(tr);
  });

  // Update metrics
  if (filtered.length) {
    document.getElementById("mDown").textContent = filtered[0].download.toFixed(2) + " Mbps";
    document.getElementById("mUp").textContent   = filtered[0].upload.toFixed(2) + " Mbps";
    document.getElementById("mPing").textContent = filtered[0].ping.toFixed(0) + " ms";
  }

  // Prepare chart data
  const labels = [...filtered].reverse().map(r => r.timestamp);
  const dl = [...filtered].reverse().map(r => r.download);
  const ul = [...filtered].reverse().map(r => r.upload);
  const pg = [...filtered].reverse().map(r => r.ping);

  if (!chart) {
    const ctx = document.getElementById("chartLine").getContext("2d");
    chart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [
          { label: "Download", data: dl, borderColor: "#58a6ff", fill: false, tension: 0.35 },
          { label: "Upload", data: ul, borderColor: "#2ecc71", fill: false, tension: 0.35 },
          { label: "Ping", data: pg, borderColor: "#e74c3c", yAxisID: "y2", fill: false, tension: 0.35 }
        ]
      },
      options: {
        responsive: true,
        interaction: { mode: "index", intersect: false },
        animation: { duration: 800, easing: "easeInOutCubic" },
        scales: {
          y: { title: { display: true, text: "Mbps" } },
          y2: { position: "right", title: { display: true, text: "ms" }, grid: { drawOnChartArea: false } },
          x: { ticks: { maxTicksLimit: 10 } }
        }
      }
    });
  } else {
    chart.data.labels = labels;
    chart.data.datasets[0].data = dl;
    chart.data.datasets[1].data = ul;
    chart.data.datasets[2].data = pg;
    chart.update();
  }

  // Save last values to base
  if (dl.length) {
    base.dl = dl[dl.length - 1];
    base.ul = ul[ul.length - 1];
    base.pg = pg[pg.length - 1];
  }

  ensureJitterLoop();
}

    function ensureJitterLoop() {
      if (!jitterTimer) jitterTimer = setInterval(jitterRecent, 500);
    }

    function jitterRecent() {
      if (!chart) return;
      const last = chart.data.labels.length - 1;
      if (last < 0) return;
      const jitterMbps = 1.5, jitterMs = 3.0;
      const d = Math.max(0, base.dl + (Math.random() - 0.5) * jitterMbps);
      const u = Math.max(0, base.ul + (Math.random() - 0.5) * jitterMbps);
      const p = Math.max(0, base.pg + (Math.random() - 0.5) * jitterMs);
      chart.data.datasets[0].data[last] = d;
      chart.data.datasets[1].data[last] = u;
      chart.data.datasets[2].data[last] = p;
      chart.update("none");
      document.getElementById("mDown").textContent = d.toFixed(2) + " Mbps";
      document.getElementById("mUp").textContent   = u.toFixed(2) + " Mbps";
      document.getElementById("mPing").textContent = Math.round(p) + " ms";
    }

    loadData();
    setInterval(loadData, REFRESH_INTERVAL);
  </script>
</body>
</html>

